{"version":3,"sources":["../../src/commands/build.js"],"names":["path","require","report","buildHTML","buildProductionBundle","bootstrap","apiRunnerNode","copyStaticDirs","initTracer","stopTracer","db","signalExit","telemetry","store","emitter","queryUtil","appDataUtil","WorkerPool","structureWebpackErrors","waitJobsFinished","Promise","resolve","reject","onEndJob","getState","jobs","active","length","off","on","module","exports","build","program","publicDir","join","directory","openTracingConfigFile","buildActivity","phantomActivity","start","trackCli","exitCode","buildSpan","span","setTag","graphqlRunner","parentSpan","processPageQueries","processStaticQueries","getInitialQueryProcessors","graphql","activity","activityTimer","stats","catch","err","panic","end","workerPool","create","webpackCompilationHash","hash","exists","dispatch","type","payload","write","boundActionCreators","setProgramStatus","saveState","pagePaths","pages","keys","createProgress","buildPages","stage","id","context","errorPath","match","message","ref","error","done","info","process","uptime","finish"],"mappings":"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","sourcesContent":["/* @flow */\n\nconst path = require(`path`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst buildHTML = require(`./build-html`)\nconst buildProductionBundle = require(`./build-javascript`)\nconst bootstrap = require(`../bootstrap`)\nconst apiRunnerNode = require(`../utils/api-runner-node`)\nconst { copyStaticDirs } = require(`../utils/get-static-dir`)\nconst { initTracer, stopTracer } = require(`../utils/tracer`)\nconst db = require(`../db`)\nconst signalExit = require(`signal-exit`)\nconst telemetry = require(`gatsby-telemetry`)\nconst { store, emitter } = require(`../redux`)\nconst queryUtil = require(`../query`)\nconst appDataUtil = require(`../utils/app-data`)\nconst WorkerPool = require(`../utils/worker/pool`)\nconst { structureWebpackErrors } = require(`../utils/webpack-error-utils`)\n\ntype BuildArgs = {\n  directory: string,\n  sitePackageJson: object,\n  prefixPaths: boolean,\n  noUglify: boolean,\n  openTracingConfigFile: string,\n}\n\nconst waitJobsFinished = () =>\n  new Promise((resolve, reject) => {\n    const onEndJob = () => {\n      if (store.getState().jobs.active.length === 0) {\n        resolve()\n        emitter.off(`END_JOB`, onEndJob)\n      }\n    }\n    emitter.on(`END_JOB`, onEndJob)\n    onEndJob()\n  })\n\nmodule.exports = async function build(program: BuildArgs) {\n  const publicDir = path.join(program.directory, `public`)\n  initTracer(program.openTracingConfigFile)\n  const buildActivity = report.phantomActivity(`build`)\n  buildActivity.start()\n\n  telemetry.trackCli(`BUILD_START`)\n  signalExit(exitCode => {\n    telemetry.trackCli(`BUILD_END`, { exitCode })\n  })\n\n  const buildSpan = buildActivity.span\n  buildSpan.setTag(`directory`, program.directory)\n\n  const { graphqlRunner } = await bootstrap({\n    ...program,\n    parentSpan: buildSpan,\n  })\n\n  const {\n    processPageQueries,\n    processStaticQueries,\n  } = queryUtil.getInitialQueryProcessors({\n    parentSpan: buildSpan,\n  })\n\n  await processStaticQueries()\n\n  await apiRunnerNode(`onPreBuild`, {\n    graphql: graphqlRunner,\n    parentSpan: buildSpan,\n  })\n\n  // Copy files from the static directory to\n  // an equivalent static directory within public.\n  copyStaticDirs()\n\n  let activity = report.activityTimer(\n    `Building production JavaScript and CSS bundles`,\n    { parentSpan: buildSpan }\n  )\n  activity.start()\n  const stats = await buildProductionBundle(program, {\n    parentSpan: activity.span,\n  }).catch(err => {\n    activity.panic(structureWebpackErrors(`build-javascript`, err))\n  })\n  activity.end()\n\n  const workerPool = WorkerPool.create()\n\n  const webpackCompilationHash = stats.hash\n  if (\n    webpackCompilationHash !== store.getState().webpackCompilationHash ||\n    !appDataUtil.exists(publicDir)\n  ) {\n    store.dispatch({\n      type: `SET_WEBPACK_COMPILATION_HASH`,\n      payload: webpackCompilationHash,\n    })\n\n    activity = report.activityTimer(`Rewriting compilation hashes`, {\n      parentSpan: buildSpan,\n    })\n    activity.start()\n\n    await appDataUtil.write(publicDir, webpackCompilationHash)\n\n    activity.end()\n  }\n\n  await processPageQueries()\n\n  require(`../redux/actions`).boundActionCreators.setProgramStatus(\n    `BOOTSTRAP_QUERY_RUNNING_FINISHED`\n  )\n\n  await waitJobsFinished()\n\n  await db.saveState()\n  const pagePaths = [...store.getState().pages.keys()]\n  activity = report.createProgress(\n    `Building static HTML for pages`,\n    pagePaths.length,\n    0,\n    {\n      parentSpan: buildSpan,\n    }\n  )\n  activity.start()\n  try {\n    await buildHTML.buildPages({\n      program,\n      stage: `build-html`,\n      pagePaths,\n      activity,\n      workerPool,\n    })\n  } catch (err) {\n    let id = `95313` // TODO: verify error IDs exist\n    const context = {\n      errorPath: err.context && err.context.path,\n    }\n\n    const match = err.message.match(\n      /ReferenceError: (window|document|localStorage|navigator|alert|location) is not defined/i\n    )\n    if (match && match[1]) {\n      id = `95312`\n      context.ref = match[1]\n    }\n\n    activity.panic({\n      id,\n      context,\n      error: err,\n    })\n  }\n  activity.done()\n\n  await apiRunnerNode(`onPostBuild`, {\n    graphql: graphqlRunner,\n    parentSpan: buildSpan,\n  })\n\n  report.info(`Done building in ${process.uptime()} sec`)\n\n  buildSpan.finish()\n  await stopTracer()\n  workerPool.end()\n  buildActivity.end()\n}\n"],"file":"build.js"}