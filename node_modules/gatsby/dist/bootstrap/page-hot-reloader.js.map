{"version":3,"sources":["../../src/bootstrap/page-hot-reloader.js"],"names":["emitter","store","require","apiRunnerNode","boundActionCreators","deletePage","deleteComponentsDependencies","report","pagesDirty","graphql","on","action","payload","internal","type","runCreatePages","timestamp","Date","now","activity","activityTimer","start","traceId","waitForCascadingActions","end","Array","from","getState","pages","values","forEach","page","isCreatedByStatefulCreatePages","updatedAt","path","emit","module","exports","graphqlRunner"],"mappings":";;AAAA,MAAM;AAAEA,EAAAA,OAAF;AAAWC,EAAAA;AAAX,IAAqBC,OAAO,CAAE,UAAF,CAAlC;;AACA,MAAMC,aAAa,GAAGD,OAAO,CAAE,0BAAF,CAA7B;;AACA,MAAM;AAAEE,EAAAA;AAAF,IAA0BF,OAAO,CAAE,kBAAF,CAAvC;;AACA,MAAM;AAAEG,EAAAA,UAAF;AAAcC,EAAAA;AAAd,IAA+CF,mBAArD;;AACA,MAAMG,MAAM,GAAGL,OAAO,CAAE,yBAAF,CAAtB;;AAEA,IAAIM,UAAU,GAAG,KAAjB;AACA,IAAIC,OAAJ;AAEAT,OAAO,CAACU,EAAR,CAAY,aAAZ,EAA0BC,MAAM,IAAI;AAClC,MAAIA,MAAM,CAACC,OAAP,CAAeC,QAAf,CAAwBC,IAAxB,KAAkC,UAAtC,EAAiD;AAC/CN,IAAAA,UAAU,GAAG,IAAb;AACD;AACF,CAJD;AAKAR,OAAO,CAACU,EAAR,CAAY,aAAZ,EAA0BC,MAAM,IAAI;AAClC,MAAIA,MAAM,CAACC,OAAP,CAAeC,QAAf,CAAwBC,IAAxB,KAAkC,UAAtC,EAAiD;AAC/CN,IAAAA,UAAU,GAAG,IAAb,CAD+C,CAE/C;AACA;AACA;AACA;;AACAL,IAAAA,aAAa,CAAE,eAAF,CAAb;AACD;AACF,CATD;AAWAH,OAAO,CAACU,EAAR,CAAY,yBAAZ,EAAsC,MAAM;AAC1C,MAAIF,UAAJ,EAAgB;AACdO,IAAAA,cAAc;AACf;AACF,CAJD;;AAMA,MAAMA,cAAc,GAAG,YAAY;AACjCP,EAAAA,UAAU,GAAG,KAAb;AAEA,QAAMQ,SAAS,GAAGC,IAAI,CAACC,GAAL,EAAlB,CAHiC,CAKjC;;AACA,MAAIC,QAAQ,GAAGZ,MAAM,CAACa,aAAP,CAAsB,aAAtB,CAAf;AACAD,EAAAA,QAAQ,CAACE,KAAT;AACA,QAAMlB,aAAa,CAChB,aADgB,EAEjB;AACEM,IAAAA,OADF;AAEEa,IAAAA,OAAO,EAAG,aAFZ;AAGEC,IAAAA,uBAAuB,EAAE;AAH3B,GAFiB,EAOjB;AAAEJ,IAAAA;AAAF,GAPiB,CAAnB;AASAA,EAAAA,QAAQ,CAACK,GAAT,GAjBiC,CAmBjC;;AACAC,EAAAA,KAAK,CAACC,IAAN,CAAWzB,KAAK,CAAC0B,QAAN,GAAiBC,KAAjB,CAAuBC,MAAvB,EAAX,EAA4CC,OAA5C,CAAoDC,IAAI,IAAI;AAC1D,QACE,CAACA,IAAI,CAACC,8BAAN,IACAD,IAAI,CAACE,SAAL,GAAiBjB,SADjB,IAEAe,IAAI,CAACG,IAAL,KAAe,WAHjB,EAIE;AACA5B,MAAAA,4BAA4B,CAAC,CAACyB,IAAI,CAACG,IAAN,CAAD,CAA5B;AACA7B,MAAAA,UAAU,CAAC0B,IAAD,CAAV;AACD;AACF,GATD;AAWA/B,EAAAA,OAAO,CAACmC,IAAR,CAAc,iBAAd;AACD,CAhCD;;AAkCAC,MAAM,CAACC,OAAP,GAAiBC,aAAa,IAAI;AAChC7B,EAAAA,OAAO,GAAG6B,aAAV;AACD,CAFD","sourcesContent":["const { emitter, store } = require(`../redux`)\nconst apiRunnerNode = require(`../utils/api-runner-node`)\nconst { boundActionCreators } = require(`../redux/actions`)\nconst { deletePage, deleteComponentsDependencies } = boundActionCreators\nconst report = require(`gatsby-cli/lib/reporter`)\n\nlet pagesDirty = false\nlet graphql\n\nemitter.on(`CREATE_NODE`, action => {\n  if (action.payload.internal.type !== `SitePage`) {\n    pagesDirty = true\n  }\n})\nemitter.on(`DELETE_NODE`, action => {\n  if (action.payload.internal.type !== `SitePage`) {\n    pagesDirty = true\n    // Make a fake API call to trigger `API_RUNNING_QUEUE_EMPTY` being called.\n    // We don't want to call runCreatePages here as there might be work in\n    // progress. So this is a safe way to make sure runCreatePages gets called\n    // at a safe time.\n    apiRunnerNode(`FAKE_API_CALL`)\n  }\n})\n\nemitter.on(`API_RUNNING_QUEUE_EMPTY`, () => {\n  if (pagesDirty) {\n    runCreatePages()\n  }\n})\n\nconst runCreatePages = async () => {\n  pagesDirty = false\n\n  const timestamp = Date.now()\n\n  // Collect pages.\n  let activity = report.activityTimer(`createPages`)\n  activity.start()\n  await apiRunnerNode(\n    `createPages`,\n    {\n      graphql,\n      traceId: `createPages`,\n      waitForCascadingActions: true,\n    },\n    { activity }\n  )\n  activity.end()\n\n  // Delete pages that weren't updated when running createPages.\n  Array.from(store.getState().pages.values()).forEach(page => {\n    if (\n      !page.isCreatedByStatefulCreatePages &&\n      page.updatedAt < timestamp &&\n      page.path !== `/404.html`\n    ) {\n      deleteComponentsDependencies([page.path])\n      deletePage(page)\n    }\n  })\n\n  emitter.emit(`CREATE_PAGE_END`)\n}\n\nmodule.exports = graphqlRunner => {\n  graphql = graphqlRunner\n}\n"],"file":"page-hot-reloader.js"}